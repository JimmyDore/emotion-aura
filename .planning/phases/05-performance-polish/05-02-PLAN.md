---
phase: 05-performance-polish
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - src/particles/QualityScaler.ts
  - src/scene/SceneManager.ts
  - src/main.ts
  - src/style.css
  - src/ui/EmotionOverlay.ts
  - src/ui/GestureOverlay.ts
autonomous: false

must_haves:
  truths:
    - "Quality scaling operates silently with no visible 'Quality: reduced' indicator"
    - "Stats overlay (FPS counter) is visible by default with a toggle button to hide/show"
    - "Emotion and gesture overlays can be toggled visible/hidden with a single button"
    - "'Emotion Aura' title and jimmydore.fr link are visible on screen"
    - "WebGL context loss is handled gracefully (render loop pauses and resumes)"
    - "gl_PointSize is capped to the browser's hardware limit to prevent silent clamping"
    - "Particle spawn positions and gesture force fields align spatially with the webcam feed and MediaPipe landmarks (no offset)"
  artifacts:
    - path: "src/particles/QualityScaler.ts"
      provides: "Silent quality scaler without DOM indicator"
      contains: "class QualityScaler"
    - path: "src/scene/SceneManager.ts"
      provides: "WebGL context loss handling and renderer getter"
      contains: "webglcontextlost"
    - path: "src/main.ts"
      provides: "Toggle buttons, branding, pointSize safety check"
      contains: "toggle-btn"
    - path: "src/style.css"
      provides: "Toggle button and branding CSS styles"
      contains: "toggle-btn"
  key_links:
    - from: "src/main.ts"
      to: "src/ui/EmotionOverlay.ts"
      via: "Toggle button shows/hides overlay root element"
      pattern: "getRoot|style\\.display"
    - from: "src/main.ts"
      to: "src/ui/GestureOverlay.ts"
      via: "Toggle button shows/hides overlay root element"
      pattern: "getRoot|style\\.display"
    - from: "src/scene/SceneManager.ts"
      to: "src/main.ts"
      via: "Context loss events pause/resume render loop"
      pattern: "webglcontextlost|webglcontextrestored"
---

<objective>
Add cross-browser robustness (context loss handling, pointSize safety), remove the visible quality indicator, and build the fullscreen immersive UI layer with toggle buttons for stats/overlays and "Emotion Aura" branding.

Purpose: This transforms the developer-facing application into a portfolio-ready experience. Silent quality degradation, graceful error handling, toggleable overlays, and branding are the finishing touches that make it presentable.
Output: Silent QualityScaler, context loss handling in SceneManager, toggle buttons and branding in main.ts, and supporting CSS/overlay changes.
</objective>

<execution_context>
@/Users/jimmydore/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jimmydore/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-performance-polish/05-CONTEXT.md
@.planning/phases/05-performance-polish/05-RESEARCH.md
@.planning/phases/05-performance-polish/05-01-SUMMARY.md

@src/particles/QualityScaler.ts
@src/scene/SceneManager.ts
@src/main.ts
@src/style.css
@src/ui/EmotionOverlay.ts
@src/ui/GestureOverlay.ts
@src/core/constants.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Silent quality scaler, context loss handling, and pointSize safety</name>
  <files>
    src/particles/QualityScaler.ts
    src/scene/SceneManager.ts
    src/style.css
  </files>
  <action>
**QualityScaler.ts -- Remove visible indicator:**

1. Remove the `createIndicator()` method entirely.
2. Remove the `updateIndicator()` method entirely.
3. Remove the `indicator` private field.
4. Remove the `this.createIndicator()` call from the constructor.
5. Remove the `this.updateIndicator()` call from `update()`.
6. In `dispose()`, remove the indicator removal logic (the method can become a no-op or be kept for future cleanup).
7. Keep ALL scaling logic exactly as-is (the rolling window, hysteresis, scale up/down thresholds). The quality degradation strategy per the user decision is: reduce particle count first, keep ML intact, operate silently.

**style.css -- Remove quality indicator styles:**

Remove the entire `.quality-indicator` CSS block (lines ~317-332 in current file). The rest of style.css remains unchanged (Plan 01 already updated #webcam brightness).

**SceneManager.ts -- Add context loss handling and renderer access:**

1. Add WebGL context loss/restoration event handlers on the canvas in the constructor:
```typescript
canvas.addEventListener('webglcontextlost', (event) => {
  event.preventDefault(); // Allows context restoration attempt
  console.warn('WebGL context lost -- pausing render loop');
});

canvas.addEventListener('webglcontextrestored', () => {
  console.info('WebGL context restored -- resuming');
});
```

2. Expose the renderer via a getter so main.ts can query gl parameters:
```typescript
getRenderer(): THREE.WebGLRenderer {
  return this.renderer;
}
```

3. Add a method to check if context is lost:
```typescript
isContextLost(): boolean {
  return this.renderer.getContext().isContextLost();
}
```

4. In `dispose()`, remove the context loss event listeners (store them as named methods like `onContextLost` and `onContextRestored` so they can be removed).
  </action>
  <verify>
Run `npx tsc --noEmit` to verify no type errors. Run `npx vite build` to verify build succeeds. Verify QualityScaler.ts no longer references `indicator`, `createIndicator`, or `updateIndicator`. Verify SceneManager.ts contains `webglcontextlost` handler and `getRenderer()` method. Verify style.css does not contain `.quality-indicator`.
  </verify>
  <done>
QualityScaler operates silently with no DOM indicator. SceneManager handles WebGL context loss events and exposes renderer/context state. Quality indicator CSS is removed. Build succeeds.
  </done>
</task>

<task type="auto">
  <name>Task 2: Fullscreen UI -- toggle buttons, branding, and stats wrapper</name>
  <files>
    src/main.ts
    src/style.css
    src/ui/EmotionOverlay.ts
    src/ui/GestureOverlay.ts
  </files>
  <action>
**EmotionOverlay.ts -- Expose root element:**

Add a public method to access the root DOM element for toggle control:
```typescript
getRoot(): HTMLDivElement {
  return this.root;
}
```

**GestureOverlay.ts -- Expose root element:**

Add the same method:
```typescript
getRoot(): HTMLDivElement {
  return this.root;
}
```

**main.ts -- Add toggles, branding, and pointSize safety:**

After the existing stats.js setup and before the animate() function, add the following:

1. **PointSize safety check:** Query the hardware max point size and log it. If the max is less than 64, reduce PARTICLE_SIZE_BASE accordingly for this session (store in a local variable, use it in the spawn loop instead of the imported constant):
```typescript
const gl = sceneManager!.getRenderer().getContext();
const pointSizeRange = gl.getParameter(gl.ALIASED_POINT_SIZE_RANGE);
const maxPointSize = pointSizeRange ? pointSizeRange[1] : 64;
console.info(`Max gl_PointSize: ${maxPointSize}`);
const effectiveParticleSize = Math.min(PARTICLE_SIZE_BASE, maxPointSize / (Math.min(window.devicePixelRatio, 2) * 1.5));
```
Then in the spawn loop, replace `PARTICLE_SIZE_BASE` with `effectiveParticleSize` when computing particle `size`.

2. **Branding element:** Create a branding div with "Emotion Aura" title and jimmydore.fr link, positioned at the top-center of the viewport:
```typescript
const branding = document.createElement('div');
branding.className = 'branding';
branding.innerHTML = `
  <span class="branding__title">Emotion Aura</span>
  <a class="branding__link" href="https://jimmydore.fr" target="_blank" rel="noopener">jimmydore.fr</a>
`;
document.body.appendChild(branding);
```

3. **Stats toggle button (bottom-left):** Create a toggle button that shows/hides the stats.js panel:
```typescript
let statsVisible = true;
const statsToggle = document.createElement('button');
statsToggle.className = 'toggle-btn';
statsToggle.textContent = 'Stats';
statsToggle.style.position = 'fixed';
statsToggle.style.bottom = '16px';
statsToggle.style.left = '16px';
statsToggle.style.zIndex = '100';
statsToggle.addEventListener('click', () => {
  statsVisible = !statsVisible;
  stats.dom.style.display = statsVisible ? 'block' : 'none';
});
document.body.appendChild(statsToggle);
```

Also wrap the stats.dom positioning to use `position: 'fixed'` instead of `'absolute'`:
```typescript
stats.dom.style.position = 'fixed';
```

4. **Overlay toggle button (bottom-right):** Create a toggle button that shows/hides both the emotion overlay AND gesture overlay AND hand aura simultaneously:
```typescript
let overlaysVisible = true;
const overlayToggle = document.createElement('button');
overlayToggle.className = 'toggle-btn';
overlayToggle.textContent = 'Overlays';
overlayToggle.style.position = 'fixed';
overlayToggle.style.bottom = '16px';
overlayToggle.style.right = '16px';
overlayToggle.style.zIndex = '100';
overlayToggle.addEventListener('click', () => {
  overlaysVisible = !overlaysVisible;
  const display = overlaysVisible ? '' : 'none';
  emotionOverlay!.getRoot().style.display = display;
  gestureOverlay!.getRoot().style.display = display;
  if (handAura) handAura.style.display = display;
});
document.body.appendChild(overlayToggle);
```

5. **Context loss integration:** In the animate() function, add an early return if context is lost:
```typescript
if (sceneManager!.isContextLost()) {
  stats.end();
  rafId = requestAnimationFrame(animate);
  return;
}
```
Place this right after `stats.begin()`.

6. **HMR cleanup:** Add cleanup for the new DOM elements (branding, statsToggle, overlayToggle) in the `import.meta.hot.dispose` block.

**style.css -- Add toggle button and branding styles:**

Add these styles at the end of style.css:

```css
/* ===== Toggle Buttons ===== */
.toggle-btn {
  padding: 6px 12px;
  font-size: 11px;
  font-weight: 500;
  color: rgba(255, 255, 255, 0.5);
  background: rgba(0, 0, 0, 0.4);
  border: 1px solid rgba(255, 255, 255, 0.12);
  border-radius: 6px;
  cursor: pointer;
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
  transition: color 0.2s ease, background 0.2s ease;
  pointer-events: auto;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
}

.toggle-btn:hover {
  color: rgba(255, 255, 255, 0.85);
  background: rgba(0, 0, 0, 0.6);
}

/* ===== Branding ===== */
.branding {
  position: fixed;
  top: 16px;
  left: 50%;
  transform: translateX(-50%);
  z-index: 50;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 2px;
  pointer-events: none;
}

.branding__title {
  font-size: 14px;
  font-weight: 600;
  color: rgba(255, 255, 255, 0.7);
  letter-spacing: 0.08em;
  text-transform: uppercase;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
}

.branding__link {
  font-size: 11px;
  color: rgba(255, 255, 255, 0.35);
  text-decoration: none;
  pointer-events: auto;
  transition: color 0.2s ease;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
}

.branding__link:hover {
  color: rgba(255, 255, 255, 0.7);
}
```
  </action>
  <verify>
Run `npx tsc --noEmit` to verify no type errors. Run `npx vite build` to verify build succeeds. Verify EmotionOverlay.ts and GestureOverlay.ts have `getRoot()` methods. Verify main.ts contains toggle buttons, branding, pointSize check, and context loss early return. Verify style.css contains `.toggle-btn` and `.branding` classes.
  </verify>
  <done>
Stats toggle button at bottom-left shows/hides FPS counter. Overlay toggle button at bottom-right shows/hides emotion/gesture overlays and hand aura. "Emotion Aura" title with jimmydore.fr link at top-center. gl_PointSize is capped to hardware limit. Context loss pauses render loop gracefully. Build succeeds.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Full visual and functional verification</name>
  <what-built>
Complete Phase 5 polish: neon spark particles from head-outline aura, bright webcam feed, toggle buttons (Stats bottom-left, Overlays bottom-right), "Emotion Aura" branding at top-center, silent quality scaling, and cross-browser safety measures.
  </what-built>
  <how-to-verify>
1. Run `npx vite dev` and open http://localhost:5173 in Chrome
2. Grant camera access -- your face should be clearly visible (not dim)
3. Verify particles look like neon energy sparks (bright cores, glowing halos) not soft dots
4. Verify particles emanate from around your head outline like an aura, not just from ears
5. Make facial expressions -- emotions should produce vivid distinct colors (not washed-out neutral)
6. Click the "Stats" button (bottom-left) -- FPS counter should toggle on/off
7. Click the "Overlays" button (bottom-right) -- emotion/gesture labels should toggle on/off
8. Verify "Emotion Aura" title and jimmydore.fr link visible at top-center
9. Click the jimmydore.fr link -- should open in new tab
10. Move your face left/right/up/down -- verify particles spawn from your actual head outline, not offset from your face (PRF-05 spatial alignment)
11. Use open hand push gesture toward different screen areas -- verify the force field affects particles at the correct position matching your hand, not offset (PRF-05 spatial alignment)
12. Use fist attract gesture -- verify particles orbit toward your actual hand position
13. (Optional) Open in Firefox and Safari -- verify particles render and webcam displays correctly
  </how-to-verify>
  <resume-signal>Type "approved" or describe any visual/functional issues to fix</resume-signal>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. `npx vite build` completes successfully
3. QualityScaler has no DOM indicator (no createIndicator, no updateIndicator, no .quality-indicator CSS)
4. SceneManager handles webglcontextlost/webglcontextrestored events
5. SceneManager exposes getRenderer() and isContextLost()
6. main.ts queries ALIASED_POINT_SIZE_RANGE and caps effective particle size
7. main.ts creates Stats toggle button at bottom-left
8. main.ts creates Overlays toggle button at bottom-right
9. main.ts creates branding div with "Emotion Aura" title and jimmydore.fr link
10. EmotionOverlay.ts and GestureOverlay.ts expose getRoot() method
11. style.css contains .toggle-btn and .branding classes
12. Context loss check in animate() prevents rendering on lost context
</verification>

<success_criteria>
- Application runs at 30+ FPS with all systems active
- Quality degrades silently (no visible indicator) when FPS drops
- Stats overlay visible by default with toggle button to hide/show
- Emotion and gesture overlays toggle on/off with single button
- "Emotion Aura" branding and jimmydore.fr link visible on screen
- WebGL context loss is handled gracefully
- gl_PointSize respects hardware limits
- Full build compiles and serves without errors
</success_criteria>

<output>
After completion, create `.planning/phases/05-performance-polish/05-02-SUMMARY.md`
</output>
