---
phase: 05-performance-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/particles/shaders/particle.frag.glsl
  - src/particles/FaceLandmarkTracker.ts
  - src/main.ts
  - src/core/constants.ts
  - src/style.css
autonomous: true

must_haves:
  truths:
    - "Particles look like neon energy sparks with tight bright cores and medium glow halos, not soft dots"
    - "Particles emanate outward from around the head outline like an aura, not just from ears"
    - "The user's face is clearly visible through the webcam feed, not hidden behind dark dimming"
  artifacts:
    - path: "src/particles/shaders/particle.frag.glsl"
      provides: "Neon spark fragment shader with three-term exponential falloff"
      contains: "core.*halo.*outer"
    - path: "src/particles/FaceLandmarkTracker.ts"
      provides: "FACE_OVAL-based spawn points replacing ear-only spawn"
      contains: "FACE_OVAL"
    - path: "src/style.css"
      provides: "Webcam brightness fix"
      contains: "brightness(0.8"
  key_links:
    - from: "src/particles/FaceLandmarkTracker.ts"
      to: "src/main.ts"
      via: "FaceLandmarkTracker.update() returns oval spawn points used in spawn loop"
      pattern: "faceLandmarkTracker\\.update"
    - from: "src/particles/shaders/particle.frag.glsl"
      to: "src/particles/ParticleSystem.ts"
      via: "Fragment shader imported by ParticleSystem ShaderMaterial"
      pattern: "import fragmentShader"
---

<objective>
Transform Emotion Aura's particle visuals from soft dots to neon energy sparks, migrate particle spawn from ear landmarks to a head-outline aura (FACE_OVAL contour), and fix the dark webcam feed so the user's face is clearly visible.

Purpose: These three changes are the biggest visual impact items. Together they transform the look from "tech demo" to "portfolio piece" -- neon sparks emanating from a head aura over a clearly visible face.
Output: Updated fragment shader, overhauled FaceLandmarkTracker with FACE_OVAL spawn points, webcam brightness CSS fix, and rewired spawn logic in main.ts.
</objective>

<execution_context>
@/Users/jimmydore/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jimmydore/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-performance-polish/05-CONTEXT.md
@.planning/phases/05-performance-polish/05-RESEARCH.md

@src/particles/shaders/particle.frag.glsl
@src/particles/FaceLandmarkTracker.ts
@src/main.ts
@src/core/constants.ts
@src/style.css
@src/particles/ParticleSystem.ts
@src/particles/EmotionProfile.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Neon spark shader and webcam brightness fix</name>
  <files>
    src/particles/shaders/particle.frag.glsl
    src/style.css
    src/core/constants.ts
  </files>
  <action>
**Fragment shader (particle.frag.glsl):** Replace the current two-term glow with a three-term neon spark falloff. The goal is tight bright cores with medium glow halos -- vibrant, electric, not soft/ethereal.

Replace the existing glow calculation:
```glsl
float glow = exp(-dist * 6.0) * 0.8 + exp(-dist * 2.0) * 0.2;
```

With a three-term exponential:
```glsl
// Neon spark: tight bright core + medium glow halo + soft outer reach
float core  = exp(-dist * 12.0);          // bright center spark
float halo  = exp(-dist * 4.0) * 0.5;     // energy halo
float outer = exp(-dist * 1.5) * 0.15;    // subtle atmospheric glow
float glow = core + halo + outer;
```

Also update the fade for snappier spark feel (quicker fade-in, slightly longer fade-out):
```glsl
float fade = smoothstep(0.0, 0.08, vLife) * smoothstep(1.0, 0.75, vLife);
```

And boost the color output for neon intensity (additive blending handles values > 1.0):
```glsl
gl_FragColor = vec4(vColor * glow * 1.4, glow * fade);
```

**Webcam brightness (style.css):** Change `#webcam` filter from `brightness(0.3)` to `brightness(0.8) contrast(1.1) saturate(1.05)`. This makes the face clearly visible while keeping enough contrast for particles to pop. Do NOT go to brightness(1.0) or higher -- particles wash out with additive blending on bright backgrounds.

**Constants (constants.ts):** Increase NEUTRAL_SUPPRESSION_FACTOR from 2.5 to 3.5 to reduce neutral color blending when a strong emotion is detected (user decision: emotion intensity should not heavily influence particle behavior, but dominant emotions should produce distinct colors). This makes emotional colors more vivid and less muddied by neutral gray.
  </action>
  <verify>
Run `npx tsc --noEmit` to verify no type errors. Run `npx vite build` to verify the shader compiles and bundle succeeds. Visually: the shader change is purely parameter tuning within existing structure -- if it compiles, the math is valid.
  </verify>
  <done>
Fragment shader uses three-term exponential (core/halo/outer) with color boost of 1.4x. Webcam CSS filter is brightness(0.8) contrast(1.1) saturate(1.05). NEUTRAL_SUPPRESSION_FACTOR is 3.5. Build succeeds.
  </done>
</task>

<task type="auto">
  <name>Task 2: Migrate spawn from ears to FACE_OVAL head outline</name>
  <files>
    src/particles/FaceLandmarkTracker.ts
    src/main.ts
  </files>
  <action>
**FaceLandmarkTracker.ts -- Complete overhaul:**

Replace the ear-based spawn with FACE_OVAL contour spawning. The tracker should now:

1. Define FACE_OVAL_INDICES as a static readonly array (36 indices from MediaPipe's FACEMESH_FACE_OVAL):
```typescript
private static readonly FACE_OVAL_INDICES = [
  10, 338, 297, 332, 284, 251, 389, 356, 454, 323,
  361, 288, 397, 365, 379, 378, 400, 377, 152, 148,
  176, 149, 150, 136, 172, 58, 132, 93, 234, 127,
  162, 21, 54, 103, 67, 109,
] as const;
```

2. Change the `FaceSpawnPoints` interface to:
```typescript
export interface FaceSpawnPoints {
  /** Face center for spawn-center uniform. */
  center: { x: number; y: number };
  /** Get a random spawn point on the face oval contour. Call once per particle spawn. */
  getRandomSpawnPoint: () => { x: number; y: number };
}
```

3. In the `update()` method:
   - Compute face center from the average of all FACE_OVAL landmarks (not just nose tip -- the average gives a more stable center for the halo effect).
   - Store all 36 oval landmark positions (converted to scene coords) in a private array, smoothed with EMA.
   - Return a FaceSpawnPoints object with a `getRandomSpawnPoint()` method that picks a random FACE_OVAL landmark and returns its smoothed scene coordinates.
   - Remove the leftEar/rightEar properties entirely.

4. Keep the existing `toScene()` and `smooth()` private methods. Add a smoothed array for the oval points (Array of 36 {x,y} objects, each individually EMA-smoothed).

5. The `reset()` method should clear all smoothed oval points and the center.

**main.ts -- Rewire spawn loop:**

In the spawn section of `animate()`, replace the ear-based spawning with oval-based spawning:

1. Replace `const spawnSources = [facePoints.leftEar, facePoints.rightEar];` and the alternating logic with:
```typescript
const source = facePoints.getRandomSpawnPoint();
```

2. The direction computation stays the same: outward from `facePoints.center` through the spawn point. The spread and speed logic from the emotion profile remains unchanged.

3. Remove the `// Alternate between left and right ear` comment and the `spawnSources[Math.random() < 0.5 ? 0 : 1]` selection.

4. The spawn offset `(Math.random() - 0.5) * 0.1` remains for slight randomization.

**Important:** Do NOT change the gesture force field section, quality scaler section, or any other part of main.ts. Only modify the spawn loop (approximately lines 265-334).
  </action>
  <verify>
Run `npx tsc --noEmit` to verify no type errors (the interface change will catch any mismatches). Run `npx vite build` to verify the full build succeeds. Check that `FaceLandmarkTracker.ts` exports `FaceSpawnPoints` with `center` and `getRandomSpawnPoint`. Check that main.ts no longer references `leftEar` or `rightEar`.
  </verify>
  <done>
FaceLandmarkTracker uses 36 FACE_OVAL landmark indices for spawn points. FaceSpawnPoints interface has `center` and `getRandomSpawnPoint()`. main.ts spawn loop calls `getRandomSpawnPoint()` instead of alternating between ears. Build succeeds with no type errors.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. `npx vite build` completes successfully
3. Fragment shader contains three-term exponential (core + halo + outer) with 1.4x color boost
4. FaceLandmarkTracker.ts contains FACE_OVAL_INDICES array with 36 entries
5. main.ts spawn loop uses getRandomSpawnPoint(), does not reference leftEar/rightEar
6. style.css #webcam filter is brightness(0.8) contrast(1.1) saturate(1.05)
7. constants.ts NEUTRAL_SUPPRESSION_FACTOR is 3.5
</verification>

<success_criteria>
- Neon spark shader produces tight bright cores with wider glow halos (three-term exponential)
- Particles spawn from random points around the full head oval contour, not just ears
- Webcam feed is bright enough to clearly see the user's face
- Neutral color blending is reduced so dominant emotions produce distinct colors
- Full build compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/05-performance-polish/05-01-SUMMARY.md`
</output>
