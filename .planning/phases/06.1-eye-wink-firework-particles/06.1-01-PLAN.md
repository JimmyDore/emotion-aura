---
phase: 06.1-eye-wink-firework-particles
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/core/types.ts
  - src/core/constants.ts
  - src/ml/WinkDetector.ts
  - src/particles/FireworkSpawner.ts
  - src/main.ts
autonomous: false

must_haves:
  truths:
    - "Closing the left eye (while right stays open) triggers a GOLD firework burst on the LEFT side of the screen"
    - "Closing the right eye (while left stays open) triggers a CYAN firework burst on the RIGHT side of the screen"
    - "Blinking (both eyes closed) triggers DOUBLE fireworks — GOLD on left AND CYAN on right simultaneously"
    - "Rapid winking fires rapidly with only 250ms cooldown — firework machine gun effect is desired"
    - "Firework particles linger and drift for 5-8 seconds before fading"
    - "Firework particles expand radially outward from a single tight point with no gravity"
    - "Hand gesture force fields (push/attract) automatically affect firework particles"
  artifacts:
    - path: "src/ml/WinkDetector.ts"
      provides: "Wink/blink detection from blendshape scores with per-side independent cooldowns"
      exports: ["WinkDetector"]
    - path: "src/particles/FireworkSpawner.ts"
      provides: "Radial burst spawning of 150 firework particles into shared ParticlePool"
      exports: ["spawnFirework"]
    - path: "src/core/types.ts"
      provides: "WinkSide type and WinkEvent interface"
      contains: "WinkSide"
    - path: "src/core/constants.ts"
      provides: "Wink detection thresholds and firework spawn parameters"
      contains: "WINK_THRESHOLD"
    - path: "src/main.ts"
      provides: "Wink detection and firework spawning wired into face frame branch"
      contains: "winkDetector"
  key_links:
    - from: "src/main.ts"
      to: "src/ml/WinkDetector.ts"
      via: "winkDetector.update(categories, now) called in face frame branch, returns WinkEvent[]"
      pattern: "winkDetector\\.update"
    - from: "src/main.ts"
      to: "src/particles/FireworkSpawner.ts"
      via: "spawnFirework() called for each WinkEvent in the returned array"
      pattern: "spawnFirework"
    - from: "src/particles/FireworkSpawner.ts"
      to: "src/particles/ParticleSystem.ts"
      via: "Calls particleSystem.spawn() 150 times in a loop with radial velocities"
      pattern: "particleSystem\\.spawn"
---

<objective>
Detect individual eye winks AND blinks via FaceLandmarker blendshapes and trigger spectacular firework particle bursts on the corresponding screen side. Left eye closed = GOLD firework on left side, right eye closed = CYAN firework on right side. Both eyes closed (blink) = DOUBLE firework on BOTH sides simultaneously.

Purpose: Add a playful interactive layer to the Emotion Aura experience — eye winks become triggers for dramatic firework effects. Blinks are embraced as a bonus (double firework), not filtered as noise. Rapid winking creates a "firework machine gun" effect.

Output: Two new modules (WinkDetector class, spawnFirework function) wired into the render loop, with extended types and constants. No new dependencies. Firework particles share the existing ParticlePool so hand gestures automatically affect them.
</objective>

<execution_context>
@/Users/jimmydore/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jimmydore/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06.1-eye-wink-firework-particles/06.1-RESEARCH.md
@.planning/phases/06.1-eye-wink-firework-particles/06.1-CONTEXT.md
@src/core/types.ts
@src/core/constants.ts
@src/particles/ParticleSystem.ts
@src/particles/ParticlePool.ts
@src/main.ts
@src/ml/EmotionClassifier.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add types, constants, WinkDetector, and FireworkSpawner</name>
  <files>
    src/core/types.ts
    src/core/constants.ts
    src/ml/WinkDetector.ts
    src/particles/FireworkSpawner.ts
  </files>
  <action>
    1. In `src/core/types.ts`, add at the end of the file:
       ```typescript
       /** Which side of the screen a wink firework targets. */
       export type WinkSide = 'left' | 'right';

       /** A detected wink or blink event with side and timestamp. */
       export interface WinkEvent {
         side: WinkSide;
         timestamp: number;
       }
       ```

    2. In `src/core/constants.ts`, add a new section after the Gesture Detection section (after line 129):
       ```typescript
       // ── Wink Detection ───────────────────────────────────────────────────
       /** Eye blink score threshold — above this = eye closed. Requires deliberate closure. */
       export const WINK_THRESHOLD = 0.5;

       /** Milliseconds cooldown between firework triggers PER SIDE (independent timers). */
       export const WINK_COOLDOWN_MS = 250;

       // ── Firework Particles ────────────────────────────────────────────────
       /** Particles per firework burst. */
       export const FIREWORK_PARTICLE_COUNT = 150;

       /** Radial velocity range (scene units/sec). */
       export const FIREWORK_SPEED_MIN = 0.3;
       export const FIREWORK_SPEED_MAX = 0.8;

       /** Particle lifetime range (seconds) — long linger and drift. */
       export const FIREWORK_LIFETIME_MIN = 5.0;
       export const FIREWORK_LIFETIME_MAX = 8.0;

       /** Particle size range (pixels, before pixel ratio scaling). */
       export const FIREWORK_SIZE_MIN = 15;
       export const FIREWORK_SIZE_MAX = 45;

       /** How far toward screen edge to place burst origin (0.8 = 80%). */
       export const FIREWORK_SCREEN_X_FACTOR = 0.8;

       /** Per-channel color jitter for visual richness (+/- this value). */
       export const FIREWORK_COLOR_JITTER = 0.08;

       /** Origin position jitter (scene units, +/- this value). Minimal — single point origin. */
       export const FIREWORK_ORIGIN_JITTER = 0.02;

       /** GOLD color for LEFT wink fireworks [R, G, B]. */
       export const FIREWORK_COLOR_GOLD: [number, number, number] = [1.0, 0.84, 0.0];

       /** CYAN color for RIGHT wink fireworks [R, G, B]. */
       export const FIREWORK_COLOR_CYAN: [number, number, number] = [0.0, 0.9, 1.0];
       ```

    3. Create `src/ml/WinkDetector.ts`:
       - Import `WinkEvent` from `../core/types.ts`
       - Import `WINK_THRESHOLD`, `WINK_COOLDOWN_MS` from `../core/constants.ts`
       - Class `WinkDetector` with:
         - Private `lastLeftTrigger: number = 0` and `lastRightTrigger: number = 0`
         - Method `update(categories: Array<{categoryName: string; score: number}>, now: number): WinkEvent[]`
           - Build a lookup map (same pattern as EmotionClassifier): `const get = (name: string) => blendshapeMap.get(name) ?? 0;`
           - Read `leftScore = get('eyeBlinkLeft')` and `rightScore = get('eyeBlinkRight')`
           - `leftClosed = leftScore >= WINK_THRESHOLD`
           - `rightClosed = rightScore >= WINK_THRESHOLD`
           - Create empty `events: WinkEvent[]` array
           - If `leftClosed` AND `(now - this.lastLeftTrigger) >= WINK_COOLDOWN_MS`:
             - Push `{ side: 'left', timestamp: now }`
             - Set `this.lastLeftTrigger = now`
           - If `rightClosed` AND `(now - this.lastRightTrigger) >= WINK_COOLDOWN_MS`:
             - Push `{ side: 'right', timestamp: now }`
             - Set `this.lastRightTrigger = now`
           - Return `events` (can be 0, 1, or 2 elements — 2 = both eyes closed = blink)

       CRITICAL: Do NOT add an asymmetry/open check. Do NOT filter blinks. Both eyes closed = BOTH fire independently. Each side has its own cooldown. The method returns an array, NOT `WinkEvent | null`.

       Follow existing codebase style: TypeScript strict, semicolons, JSDoc comments on public methods.

    4. Create `src/particles/FireworkSpawner.ts`:
       - Import firework constants from `../core/constants.ts`: `FIREWORK_PARTICLE_COUNT`, `FIREWORK_SPEED_MIN`, `FIREWORK_SPEED_MAX`, `FIREWORK_LIFETIME_MIN`, `FIREWORK_LIFETIME_MAX`, `FIREWORK_SIZE_MIN`, `FIREWORK_SIZE_MAX`, `FIREWORK_SCREEN_X_FACTOR`, `FIREWORK_COLOR_JITTER`, `FIREWORK_ORIGIN_JITTER`, `FIREWORK_COLOR_GOLD`, `FIREWORK_COLOR_CYAN`
       - Import `ParticleSystem` from `./ParticleSystem.ts`
       - Import `WinkSide` from `../core/types.ts`
       - Export a function `spawnFirework(particleSystem: ParticleSystem, side: WinkSide, aspect: number): void`
         - Determine burst center X:
           - `'left'`: `x = -aspect * FIREWORK_SCREEN_X_FACTOR`
           - `'right'`: `x = +aspect * FIREWORK_SCREEN_X_FACTOR`
         - Center Y: `0` (vertical center)
         - Determine base color:
           - `'left'`: `FIREWORK_COLOR_GOLD` — [1.0, 0.84, 0.0]
           - `'right'`: `FIREWORK_COLOR_CYAN` — [0.0, 0.9, 1.0]
         - Loop `FIREWORK_PARTICLE_COUNT` (150) times:
           - Random angle: `Math.random() * Math.PI * 2`
           - Random speed: `FIREWORK_SPEED_MIN + Math.random() * (FIREWORK_SPEED_MAX - FIREWORK_SPEED_MIN)`
           - `vx = Math.cos(angle) * speed`, `vy = Math.sin(angle) * speed`
           - Color jitter: for each channel, `Math.max(0, Math.min(1, baseColor[i] + (Math.random() - 0.5) * FIREWORK_COLOR_JITTER * 2))`
           - Random size: `FIREWORK_SIZE_MIN + Math.random() * (FIREWORK_SIZE_MAX - FIREWORK_SIZE_MIN)`
           - Random lifetime: `FIREWORK_LIFETIME_MIN + Math.random() * (FIREWORK_LIFETIME_MAX - FIREWORK_LIFETIME_MIN)`
           - Origin jitter: `(Math.random() - 0.5) * FIREWORK_ORIGIN_JITTER * 2` on both axes
           - Call `particleSystem.spawn(centerX + ox, centerY + oy, vx, vy, r, g, b, size, lifetime)`

       Do NOT create a class — just a single exported function. Do NOT create a separate Three.js mesh or modify shaders. The existing ParticleSystem with its shared pool and neon spark shader handles everything.
  </action>
  <verify>
    Run `npx tsc --noEmit` from project root. No type errors in any file.
  </verify>
  <done>
    WinkDetector class exists with update() returning WinkEvent[] (0, 1, or 2 events). spawnFirework() function exists. Types and constants match all user decisions: GOLD/CYAN colors, 150 particles, 5.0-8.0s lifetime, 250ms cooldown, 0.5 threshold, 80% screen edge, no blink filtering. TypeScript compiles cleanly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire WinkDetector and FireworkSpawner into main.ts render loop</name>
  <files>
    src/main.ts
  </files>
  <action>
    1. Add imports at the top of `src/main.ts` (near the other ML/particle imports):
       ```typescript
       import { WinkDetector } from './ml/WinkDetector.ts';
       import { spawnFirework } from './particles/FireworkSpawner.ts';
       ```

    2. Add module-level instance near the other detector/state instances (around line 36-49):
       ```typescript
       const winkDetector = new WinkDetector();
       ```

    3. Inside the face frame branch, AFTER the line `lastFaceLandmarks = result.faceLandmarks?.[0];` (line 292) and still INSIDE the `if (result.faceBlendshapes && result.faceBlendshapes.length > 0)` block, add:
       ```typescript
       // Wink/blink detection → firework burst(s)
       const winkEvents = winkDetector.update(
         result.faceBlendshapes[0].categories,
         performance.now(),
       );
       for (const event of winkEvents) {
         spawnFirework(particleSystem!, event.side, aspect);
       }
       ```

       Note: `aspect` is already computed every frame at line 268 (`const aspect = window.innerWidth / window.innerHeight;`). The variable is in scope.

    That's it. No other changes to main.ts. The existing ParticleSystem, shaders, QualityScaler, and force field application handle the rest. Firework particles live in the shared ParticlePool, so hand gesture push/attract automatically affects them.
  </action>
  <verify>
    1. Run `npx tsc --noEmit` — no type errors.
    2. Run `npm run build` — builds without errors.
    3. Verify the wiring: main.ts imports WinkDetector + spawnFirework, calls winkDetector.update() in face frame branch, iterates returned events and calls spawnFirework() for each.
  </verify>
  <done>
    main.ts imports and instantiates WinkDetector, calls update() every face frame, and triggers spawnFirework() for each returned WinkEvent. A left wink produces 1 event (left), a right wink produces 1 event (right), a blink produces 2 events (left + right = double firework). The app builds cleanly.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Eye wink/blink firework particle system with GOLD and CYAN colors. Closing one eye triggers a firework burst on the corresponding screen side. Blinking (both eyes) triggers DOUBLE fireworks on both sides simultaneously. Rapid winking creates a machine gun effect (250ms cooldown).</what-built>
  <how-to-verify>
    1. Run `npm run dev` and open the app in browser
    2. Allow camera access and wait for face detection to activate
    3. Close your LEFT eye only (keep right eye open) — a GOLD firework burst should appear on the LEFT side of the screen
    4. Close your RIGHT eye only (keep left eye open) — a CYAN firework burst should appear on the RIGHT side of the screen
    5. Blink naturally (both eyes) — DOUBLE fireworks should trigger (GOLD on left + CYAN on right simultaneously)
    6. Try rapid winking — fireworks should fire rapidly (machine gun effect, ~4 per second max per side)
    7. Verify firework particles linger for several seconds (5-8s) and drift weightlessly outward
    8. Verify firework particles spawn from a single tight point near the screen edge (80% out)
    9. Verify emotion particles still work normally alongside fireworks
    10. Verify hand gestures (push/attract) affect BOTH emotion and firework particles
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues with the firework behavior</resume-signal>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. `npm run build` succeeds
3. Manual testing: left wink → GOLD firework on left side
4. Manual testing: right wink → CYAN firework on right side
5. Manual testing: blink → DOUBLE fireworks (GOLD left + CYAN right)
6. Manual testing: rapid winking → machine gun firework effect (250ms cooldown)
7. Manual testing: firework particles linger 5-8 seconds and drift weightlessly
8. Existing emotion aura and hand gesture features remain fully functional
9. Hand gesture force fields push/attract firework particles too
</verification>

<success_criteria>
- WinkDetector detects winks AND blinks — no asymmetry filtering, each side independent
- WinkDetector.update() returns WinkEvent[] (array of 0, 1, or 2 events)
- spawnFirework() creates 150-particle radial bursts using existing ParticleSystem.spawn() API
- Colors: LEFT = GOLD [1.0, 0.84, 0.0], RIGHT = CYAN [0.0, 0.9, 1.0]
- Cooldown: 250ms per side (independent timers)
- Lifetime: 5.0-8.0 seconds (long linger)
- Position: 80% toward screen edge, vertical center
- Weightless radial expansion (no gravity — already how pool works)
- Shared ParticlePool means hand gestures automatically affect firework particles
- App builds and runs at 30+ FPS with fireworks active
</success_criteria>

<output>
After completion, create `.planning/phases/06.1-eye-wink-firework-particles/06.1-01-SUMMARY.md`
</output>
