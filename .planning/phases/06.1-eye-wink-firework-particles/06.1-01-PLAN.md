---
phase: 06.1-eye-wink-firework-particles
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/core/types.ts
  - src/core/constants.ts
  - src/ml/WinkDetector.ts
  - src/particles/FireworkSpawner.ts
  - src/main.ts
autonomous: false

must_haves:
  truths:
    - "Closing the right eye (while left stays open) triggers a blue firework burst on the right side of the screen"
    - "Closing the left eye (while right stays open) triggers a red firework burst on the left side of the screen"
    - "Natural blinks (both eyes closing) do NOT trigger fireworks"
    - "Rapid repeated winks are rate-limited by a cooldown (no firework spam)"
    - "Firework particles burst radially outward, spread, and fade within ~1-2 seconds"
    - "Existing emotion particles and hand gesture force fields continue working normally alongside fireworks"
  artifacts:
    - path: "src/ml/WinkDetector.ts"
      provides: "Wink detection from blendshape scores with asymmetry check and cooldown"
      exports: ["WinkDetector"]
    - path: "src/particles/FireworkSpawner.ts"
      provides: "Radial burst particle spawning for firework effect"
      exports: ["FireworkSpawner"]
    - path: "src/core/types.ts"
      provides: "WinkSide type and WinkEvent interface"
      contains: "WinkSide"
    - path: "src/core/constants.ts"
      provides: "Wink detection thresholds and firework spawn parameters"
      contains: "WINK_CLOSE_THRESHOLD"
    - path: "src/main.ts"
      provides: "Wink detection and firework spawning wired into face frame branch"
      contains: "winkDetector"
  key_links:
    - from: "src/main.ts"
      to: "src/ml/WinkDetector.ts"
      via: "winkDetector.update(categories) called in face frame branch"
      pattern: "winkDetector\\.update"
    - from: "src/main.ts"
      to: "src/particles/FireworkSpawner.ts"
      via: "FireworkSpawner.trigger() called when wink detected"
      pattern: "FireworkSpawner\\.trigger|fireworkSpawner\\.trigger"
    - from: "src/particles/FireworkSpawner.ts"
      to: "src/particles/ParticleSystem.ts"
      via: "Calls particleSystem.spawn() in a loop for radial burst"
      pattern: "particleSystem\\.spawn"
---

<objective>
Detect individual eye winks via FaceLandmarker blendshapes and trigger spectacular firework particle bursts on the corresponding screen side. Right eye closed = blue firework on right side, left eye closed = red firework on left side.

Purpose: Add a new interactive layer to the Emotion Aura experience -- eye winks become a playful trigger for dramatic visual effects, building on the existing face detection and particle system infrastructure.

Output: Two new classes (WinkDetector, FireworkSpawner) wired into the render loop, with extended types and constants. No new dependencies.
</objective>

<execution_context>
@/Users/jimmydore/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jimmydore/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06.1-eye-wink-firework-particles/06.1-RESEARCH.md
@src/core/types.ts
@src/core/constants.ts
@src/particles/ParticleSystem.ts
@src/particles/ParticlePool.ts
@src/main.ts
@src/ml/EmotionClassifier.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create WinkDetector class with types and constants</name>
  <files>
    src/core/types.ts
    src/core/constants.ts
    src/ml/WinkDetector.ts
  </files>
  <action>
    1. In `src/core/types.ts`, add at the end of the file:
       - `export type WinkSide = 'left' | 'right';`
       - `export interface WinkEvent { side: WinkSide; timestamp: number; }`
       These are used by WinkDetector to report which eye winked.

    2. In `src/core/constants.ts`, add a new section `// -- Wink Detection --` after the Gesture Detection section:
       - `WINK_CLOSE_THRESHOLD = 0.5` -- eye score above this = closed
       - `WINK_OPEN_THRESHOLD = 0.3` -- other eye score below this = open (asymmetry gap prevents blink false positives)
       - `WINK_COOLDOWN_MS = 500` -- minimum ms between firework triggers per eye
       Then add a section `// -- Firework Particles --`:
       - `FIREWORK_PARTICLE_COUNT = 100` -- particles per burst
       - `FIREWORK_MIN_SPEED = 0.3` -- minimum radial velocity (scene units/s)
       - `FIREWORK_MAX_SPEED = 1.8` -- maximum radial velocity (scene units/s)
       - `FIREWORK_LIFETIME_MIN = 0.8` -- shortest particle lifetime (seconds)
       - `FIREWORK_LIFETIME_MAX = 2.0` -- longest particle lifetime (seconds)
       - `FIREWORK_SIZE_MIN = 15` -- smallest particle size (pixels)
       - `FIREWORK_SIZE_MAX = 45` -- largest particle size (pixels)
       - `FIREWORK_SCREEN_X_FACTOR = 0.6` -- how far toward screen edge to place burst center (0.6 = 60%)

    3. Create `src/ml/WinkDetector.ts`:
       - Import `WinkEvent`, `WinkSide` from `../core/types.ts`
       - Import wink constants from `../core/constants.ts`
       - Class `WinkDetector` with:
         - Private `lastLeftTrigger: number = 0` and `lastRightTrigger: number = 0` (timestamps for cooldown)
         - Method `update(categories: Array<{categoryName: string; score: number}>): WinkEvent | null`
           - Build a quick lookup: `const get = (name: string) => ...` using the categories array (same pattern as EmotionClassifier.classify)
           - Read `eyeBlinkLeft` and `eyeBlinkRight` scores
           - Check left wink: `leftScore > WINK_CLOSE_THRESHOLD AND rightScore < WINK_OPEN_THRESHOLD`
           - Check right wink: `rightScore > WINK_CLOSE_THRESHOLD AND leftScore < WINK_OPEN_THRESHOLD`
           - For whichever wink is detected, check cooldown: `performance.now() - lastXTrigger > WINK_COOLDOWN_MS`
           - If cooldown passed, update `lastXTrigger = performance.now()` and return `{ side: 'left' | 'right', timestamp: performance.now() }`
           - If no wink or cooldown not elapsed, return `null`
         - Method `reset(): void` -- resets both cooldown timestamps to 0 (for testing/cleanup)
       - Export the class as default and named export

    Follow the existing codebase style: TypeScript strict, JSDoc comments on public methods, no semicolons only if that's the project style (check existing files -- the project DOES use semicolons).
  </action>
  <verify>
    Run `npx tsc --noEmit` from project root. No type errors in the new/modified files.
  </verify>
  <done>
    WinkDetector class exists with update() method that returns WinkEvent or null. Types and constants are defined. TypeScript compiles cleanly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create FireworkSpawner and wire into main render loop</name>
  <files>
    src/particles/FireworkSpawner.ts
    src/main.ts
  </files>
  <action>
    1. Create `src/particles/FireworkSpawner.ts`:
       - Import `WinkSide` from `../core/types.ts`
       - Import firework constants from `../core/constants.ts`
       - Import `ParticleSystem` from `./ParticleSystem.ts`
       - Static class or namespace `FireworkSpawner` with a single method:
         `static trigger(side: WinkSide, particleSystem: ParticleSystem, aspect: number): void`
         - Determine burst center X:
           - `'left'` side: `x = -aspect * FIREWORK_SCREEN_X_FACTOR`
           - `'right'` side: `x = +aspect * FIREWORK_SCREEN_X_FACTOR`
         - Center Y: `0` (vertical center of screen)
         - Determine color:
           - `'left'` wink: RED = `[1.0, 0.15, 0.1]`
           - `'right'` wink: BLUE = `[0.1, 0.3, 1.0]`
         - Loop `FIREWORK_PARTICLE_COUNT` times:
           - Random angle: `Math.random() * Math.PI * 2`
           - Random speed: `FIREWORK_MIN_SPEED + Math.random() * (FIREWORK_MAX_SPEED - FIREWORK_MIN_SPEED)`
           - `vx = Math.cos(angle) * speed`, `vy = Math.sin(angle) * speed`
           - Color jitter: add `(Math.random() - 0.5) * 0.15` to each channel, clamp 0-1
           - Random size: `FIREWORK_SIZE_MIN + Math.random() * (FIREWORK_SIZE_MAX - FIREWORK_SIZE_MIN)`
           - Random lifetime: `FIREWORK_LIFETIME_MIN + Math.random() * (FIREWORK_LIFETIME_MAX - FIREWORK_LIFETIME_MIN)`
           - Slight position offset: `(Math.random() - 0.5) * 0.05` on both axes
           - Call `particleSystem.spawn(centerX + offsetX, centerY + offsetY, vx, vy, r, g, b, size, lifetime)`
       - Export the class

    2. In `src/main.ts`, wire up wink detection and firework spawning:
       - Add imports at the top: `import { WinkDetector } from './ml/WinkDetector.ts'` and `import { FireworkSpawner } from './particles/FireworkSpawner.ts'`
       - Create a module-level `const winkDetector = new WinkDetector();` near the other detector/state instances
       - Inside the face frame branch (the `if (!inferenceToggle)` block), AFTER the line `lastFaceLandmarks = result.faceLandmarks?.[0];` and still inside the `if (result.faceBlendshapes && result.faceBlendshapes.length > 0)` block, add:
         ```typescript
         // Wink detection -> firework burst
         const winkEvent = winkDetector.update(result.faceBlendshapes[0].categories);
         if (winkEvent && particleSystem) {
           const aspect = window.innerWidth / window.innerHeight;
           FireworkSpawner.trigger(winkEvent.side, particleSystem, aspect);
         }
         ```
       - That's it. No other changes to main.ts. The existing particle system, shaders, and render loop handle the rest.

    IMPORTANT: Do NOT create a separate Three.js mesh or modify shaders. The existing ParticleSystem with its additive blend neon spark shader already produces spectacular visuals. Firework particles are just emotion particles with different spawn parameters (higher velocity, shorter lifetime, radial pattern).

    IMPORTANT: Use `performance.now()` for timing (not frame counting). This matches the existing pattern in GestureState.
  </action>
  <verify>
    1. Run `npx tsc --noEmit` -- no type errors.
    2. Run `npm run build` (or `npx vite build`) -- builds without errors.
    3. Verify the import chain: main.ts -> WinkDetector -> types/constants, main.ts -> FireworkSpawner -> ParticleSystem/types/constants.
  </verify>
  <done>
    FireworkSpawner class exists with trigger() method that batch-spawns radial particles. main.ts calls winkDetector.update() on every face frame and triggers FireworkSpawner when a wink is detected. The app builds cleanly.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Eye wink firework particle system: closing one eye triggers a firework burst on the corresponding screen side (left eye = red on left, right eye = blue on right). Natural blinks should NOT trigger fireworks.</what-built>
  <how-to-verify>
    1. Run `npm run dev` and open the app in browser
    2. Allow camera access and wait for face detection to activate
    3. Close your LEFT eye only (keep right eye open) -- a RED firework burst should appear on the LEFT side of the screen
    4. Close your RIGHT eye only (keep left eye open) -- a BLUE firework burst should appear on the RIGHT side of the screen
    5. Blink normally (both eyes) -- NO fireworks should trigger
    6. Try rapid winking -- fireworks should be rate-limited (max ~2 per second per eye)
    7. Verify emotion particles still work normally alongside fireworks
    8. Verify hand gestures (push/attract) still work normally
    9. Check that firework particles fade away within ~2 seconds
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues with the firework behavior</resume-signal>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. `npm run build` succeeds
3. Manual testing: left wink -> red firework left side, right wink -> blue firework right side
4. Manual testing: normal blinks do NOT trigger fireworks
5. Existing emotion aura and hand gesture features remain functional
</verification>

<success_criteria>
- WinkDetector correctly distinguishes winks from blinks using asymmetric threshold comparison
- FireworkSpawner creates visually spectacular radial particle bursts using existing ParticleSystem.spawn() API
- Fireworks appear on correct screen side with correct color (left=red, right=blue)
- 500ms cooldown prevents firework spam
- Zero impact on existing emotion detection, particle rendering, and hand gesture features
- App builds and runs at 30+ FPS with fireworks active
</success_criteria>

<output>
After completion, create `.planning/phases/06.1-eye-wink-firework-particles/06.1-01-SUMMARY.md`
</output>
