---
phase: 03-particle-system
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/particles/EmotionProfile.ts
  - src/core/constants.ts
autonomous: true

must_haves:
  truths:
    - "Each of 5 emotions has a distinct visual profile with unique colors, speed, direction, and spawn rate"
    - "Profiles are data-driven configs, not hardcoded logic branches"
    - "Intensity scaling is built into each profile (stronger expression = more dramatic effect)"
  artifacts:
    - path: "src/particles/EmotionProfile.ts"
      provides: "EmotionProfileConfig type and EMOTION_PROFILES map for all 5 emotions"
      exports: ["EmotionProfileConfig", "EMOTION_PROFILES", "lerpProfile"]
    - path: "src/core/constants.ts"
      provides: "Particle system constants (MAX_PARTICLES, SPAWN_RATE_BASE, etc.)"
      contains: "MAX_PARTICLES"
  key_links:
    - from: "src/particles/EmotionProfile.ts"
      to: "src/core/types.ts"
      via: "Imports EmotionType for profile key typing"
      pattern: "import.*EmotionType"
    - from: "src/particles/EmotionProfile.ts"
      to: "src/core/constants.ts"
      via: "References particle constants for default values"
      pattern: "import.*constants"
---

<objective>
Define the 5 emotion visual profiles (happy, sad, angry, surprised, neutral) as data-driven configurations, plus a lerp function for morph-in-place transitions between emotion states.

Purpose: Separating visual profiles from rendering logic lets the particle system react to any emotion by reading a config object rather than branching on emotion type. The lerp function enables the smooth morph-in-place transitions the user requested (existing particles gradually shift color/behavior).
Output: EmotionProfile.ts with typed configs for all 5 emotions and particle-related constants added to constants.ts.
</objective>

<execution_context>
@/Users/jimmydore/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jimmydore/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-particle-system/03-CONTEXT.md
@.planning/phases/03-particle-system/03-RESEARCH.md
@src/core/types.ts
@src/core/constants.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Particle constants in constants.ts</name>
  <files>src/core/constants.ts</files>
  <action>
Add the following particle system constants to the end of `src/core/constants.ts`. Keep all existing constants untouched.

```ts
// ── Particle System ──────────────────────────────────────────────────
/** Maximum particle count for the pre-allocated pool. */
export const MAX_PARTICLES = 1500;

/** Base spawn rate (particles/second) before emotion intensity scaling. */
export const SPAWN_RATE_BASE = 40;

/** Maximum spawn rate at full intensity. */
export const SPAWN_RATE_MAX = 120;

/** Base particle lifetime in seconds. */
export const PARTICLE_LIFETIME_BASE = 2.5;

/** Base particle size in pixels (before pixel ratio scaling). */
export const PARTICLE_SIZE_BASE = 25;

/** FPS threshold below which quality scaling activates. */
export const QUALITY_FPS_THRESHOLD = 30;

/** Duration in seconds FPS must stay below threshold before scaling down. */
export const QUALITY_SCALE_DELAY = 1.0;

/** Minimum particle count (floor for quality scaling). */
export const QUALITY_MIN_PARTICLES = 300;
```
  </action>
  <verify>Run `npx tsc --noEmit` -- should compile cleanly with no unused variable warnings (constants will be consumed by Plans 01 and 03).</verify>
  <done>Particle system constants are centralized in constants.ts as single source of truth, following the established pattern from emotion weights.</done>
</task>

<task type="auto">
  <name>Task 2: EmotionProfile configs and lerp function</name>
  <files>src/particles/EmotionProfile.ts</files>
  <action>
Create `src/particles/EmotionProfile.ts` with:

1. **EmotionProfileConfig interface:**
```ts
export interface EmotionProfileConfig {
  /** Primary and secondary color as [r, g, b] (0-1 range) */
  colors: [number, number, number][];
  /** Base particle speed (scene units per second) */
  speed: number;
  /** Primary direction vector [dx, dy] (normalized) -- particles flow this way */
  direction: [number, number];
  /** Angular spread in radians (0 = tight beam, PI = hemisphere) */
  spread: number;
  /** Size multiplier relative to PARTICLE_SIZE_BASE */
  sizeMultiplier: number;
  /** Lifetime multiplier relative to PARTICLE_LIFETIME_BASE */
  lifetimeMultiplier: number;
  /** Spawn rate multiplier relative to SPAWN_RATE_BASE */
  spawnRateMultiplier: number;
  /** Noise amplitude multiplier for organic motion (1.0 = default) */
  noiseAmplitude: number;
}
```

2. **EMOTION_PROFILES** -- a `Record<EmotionType, EmotionProfileConfig>` with these profiles:

**Happy** -- warm, lively, upward (gold/pink tones, firefly-like):
- colors: [[1.0, 0.85, 0.3], [1.0, 0.5, 0.7], [1.0, 0.95, 0.6]] (gold, pink, warm yellow)
- speed: 0.4, direction: [0, 1] (upward), spread: PI * 0.7
- sizeMultiplier: 1.2, lifetimeMultiplier: 1.0, spawnRateMultiplier: 1.3
- noiseAmplitude: 1.2 (playful organic drift)

**Sad** -- cool, slow, downward (blue tones, rain-like):
- colors: [[0.3, 0.5, 0.9], [0.2, 0.3, 0.7], [0.5, 0.6, 0.85]] (medium blue, deep blue, pale blue)
- speed: 0.15, direction: [0, -1] (downward), spread: PI * 0.3
- sizeMultiplier: 0.8, lifetimeMultiplier: 1.5 (linger longer), spawnRateMultiplier: 0.7
- noiseAmplitude: 0.4 (minimal drift, straight rain feel)

**Angry** -- aggressive, fast, radial (red/orange tones, flame-like):
- colors: [[1.0, 0.2, 0.1], [1.0, 0.5, 0.0], [1.0, 0.8, 0.2]] (red, orange, fire yellow)
- speed: 0.7, direction: [0, 0] (radial outward from center), spread: PI * 1.0
- sizeMultiplier: 1.0, lifetimeMultiplier: 0.6 (burn out fast), spawnRateMultiplier: 1.8
- noiseAmplitude: 1.8 (chaotic turbulent motion)

**Surprised** -- burst/explosion, fast radial (cyan/yellow tones):
- colors: [[0.3, 1.0, 1.0], [1.0, 1.0, 0.4], [0.6, 0.9, 1.0]] (cyan, yellow, light cyan)
- speed: 1.0, direction: [0, 0] (radial outward burst), spread: PI * 1.0
- sizeMultiplier: 1.5, lifetimeMultiplier: 0.4 (short burst), spawnRateMultiplier: 3.0
- noiseAmplitude: 0.8

**Neutral** -- calm ambient drift (grey/silver tones, gentle):
- colors: [[0.7, 0.7, 0.75], [0.5, 0.55, 0.6], [0.8, 0.82, 0.85]] (silver, grey, light silver)
- speed: 0.08, direction: [0, 0.3] (slight upward drift), spread: PI * 0.9
- sizeMultiplier: 0.7, lifetimeMultiplier: 2.0 (float around longer), spawnRateMultiplier: 0.4
- noiseAmplitude: 0.6 (gentle organic sway)

3. **lerpProfile function:**
```ts
/**
 * Linearly interpolate between two EmotionProfileConfigs.
 * Used for morph-in-place transitions when emotion changes.
 * Colors are lerped per-channel. Scalars are lerped directly.
 */
export function lerpProfile(
  a: EmotionProfileConfig,
  b: EmotionProfileConfig,
  t: number
): EmotionProfileConfig
```
- Lerp each scalar field: `a.field + (b.field - a.field) * t`
- Lerp colors: for each color index (up to min length of both arrays), lerp each RGB channel. If arrays differ in length, pad shorter with its last color.
- Lerp direction components independently
- Clamp t to [0, 1]

4. **blendProfiles function** (for multi-emotion blending using EmotionScores):
```ts
/**
 * Blend multiple emotion profiles weighted by their scores.
 * Takes EmotionScores (all 5 values summing to ~1) and produces
 * a single blended profile. Used when multiple emotions are active.
 */
export function blendProfiles(
  scores: EmotionScores
): EmotionProfileConfig
```
- For each scalar field: weighted sum across all 5 profiles using scores as weights
- For colors: weighted average of first color from each profile (yields the dominant color blend)
- Normalize direction vector after blending

Import `EmotionType` and `EmotionScores` from `../core/types.ts`.
  </action>
  <verify>
    Run `npx tsc --noEmit` -- should compile cleanly.
    Verify all 5 emotion types are covered: `grep -c "happy\|sad\|angry\|surprised\|neutral" src/particles/EmotionProfile.ts` should show multiple matches.
  </verify>
  <done>
    All 5 emotion profiles defined as data-driven configs with distinct colors, speeds, directions, and spawn rates. lerpProfile and blendProfiles functions enable smooth morph-in-place transitions. All values are tunable without changing rendering logic.
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes
- EmotionProfile.ts exports EmotionProfileConfig, EMOTION_PROFILES, lerpProfile, blendProfiles
- All 5 emotions have distinct color palettes (warm for happy, cool for sad, hot for angry, bright for surprised, muted for neutral)
- constants.ts has all particle constants (MAX_PARTICLES, SPAWN_RATE_BASE, etc.)
- lerpProfile correctly interpolates between any two profiles
</verification>

<success_criteria>
- Each emotion produces a visually distinct configuration (different colors, speed, direction, spawn rate)
- Profiles are pure data -- no rendering logic in this file
- Intensity scaling is possible via spawnRateMultiplier and sizeMultiplier
- Morph transitions are possible via lerpProfile and blendProfiles
- Constants follow established pattern (centralized in constants.ts)
</success_criteria>

<output>
After completion, create `.planning/phases/03-particle-system/03-02-SUMMARY.md`
</output>
